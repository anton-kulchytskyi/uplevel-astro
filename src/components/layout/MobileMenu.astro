---
import navData from '@/data/links.json';
import SocialButtons from '@/components/ui/SocialButtons.astro';
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '');

const formatUrl = (url: string) => {
  if (url.startsWith('http') || url.startsWith('#') || url.includes(':')) {
    return url;
  }

  const cleanUrl = url.startsWith('/') ? url : `/${url}`;
  return `${baseUrl}${cleanUrl}`;
};
---

<div class="mobile-menu" id="mobileMenu">
  <div class="mobile-menu-main" id="mobileMenuMain">
    <nav>
      <ul>
        {
          navData.main.map((link) => {
            if (link.title === 'Our Services') {
              return (
                <li>
                  <a
                    href={formatUrl(link.url)}
                    class="has-submenu"
                    id="openServicesMenu"
                  >
                    {link.title}
                    <svg
                      class="submenu-arrow"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="4"
                      width="20"
                      height="20"
                    >
                      <polyline points="9 18 15 12 9 6" />
                    </svg>
                  </a>
                </li>
              );
            }
            return (
              <li>
                <a href={formatUrl(link.url)}>{link.title}</a>
              </li>
            );
          })
        }
      </ul>
    </nav>
    <div class="mobile-menu-social-buttons">
      <SocialButtons />
    </div>
  </div>

  <div class="mobile-menu-services" id="mobileMenuServices">
    <nav>
      <ul>
        {
          navData.services.map((link) => (
            <li>
              <a href={formatUrl(link.url)}>{link.title}</a>
            </li>
          ))
        }
      </ul>
    </nav>
    <div class="mobile-menu-social-buttons">
      <SocialButtons />
    </div>
  </div>
</div>

<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

<style>
  .mobile-menu-main,
  .mobile-menu-services {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    height: 100vh;
    background: linear-gradient(
      135deg,
      rgba(43, 43, 43, 0.95) 0%,
      rgba(15, 63, 143, 0.9) 50%,
      rgba(43, 43, 43, 0.95) 100%
    );
    backdrop-filter: blur(20px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    padding: 4rem 0 2rem 0;
    overflow-y: auto;
    box-shadow: 5px 0 30px rgba(0, 0, 0, 0.3);
  }

  .mobile-menu-main {
    z-index: 1001;
  }

  .mobile-menu-services {
    z-index: 1002;
  }

  .mobile-menu-main::before,
  .mobile-menu-services::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
      radial-gradient(
        circle at 20% 30%,
        rgba(15, 63, 143, 0.3) 0%,
        transparent 50%
      ),
      radial-gradient(
        circle at 80% 70%,
        rgba(255, 255, 255, 0.1) 0%,
        transparent 50%
      );
    pointer-events: none;
  }

  .mobile-menu-main.active,
  .mobile-menu-services.active {
    left: 0;
  }

  .mobile-menu ul {
    list-style: none;
    padding: 0;
    margin: 0 0 2rem 0;
    position: relative;
    z-index: 2;
  }

  .mobile-menu li {
    margin: 0.5rem 0;
  }

  .mobile-menu nav a {
    display: block;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    border-radius: 0 25px 25px 0;
    margin-right: 1rem;
  }

  .mobile-menu nav a::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.1),
      rgba(255, 255, 255, 0.05)
    );
    transition: width 0.3s ease;
    border-radius: 0 25px 25px 0;
  }

  .mobile-menu nav a:hover::before {
    width: 100%;
  }

  .mobile-menu nav a:hover {
    color: #ffffff;
    transform: translateX(10px);
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  }

  .mobile-menu nav a.has-submenu {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .mobile-menu-social-buttons {
    width: 75%;
    margin: 0 auto;
  }

  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.6) 0%,
      rgba(15, 63, 143, 0.3) 50%,
      rgba(0, 0, 0, 0.6) 100%
    );
    backdrop-filter: blur(5px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
  }

  .mobile-menu-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }
</style>

<script>
  // DOM elements
  const mobileMenuToggle = document.getElementById('mobileMenuToggle');
  const hamburgerIcon = document.querySelector('.hamburger-icon');
  const backArrowIcon = document.querySelector('.back-arrow-icon');
  const mainPanel = document.getElementById('mobileMenuMain');
  const openServicesMenu = document.getElementById('openServicesMenu');
  const servicePanel = document.getElementById('mobileMenuServices');
  const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');

  // State
  let isSubmenuOpen = false;

  // Toggle main menu
  function toggleMainMenu() {
    const isActive = mainPanel?.classList.toggle('active');
    mobileMenuToggle?.classList.toggle('active', isActive);
    mobileMenuOverlay?.classList.toggle('active', isActive);
  }

  // Open submenu
  function openSubmenu() {
    isSubmenuOpen = true;
    servicePanel?.classList.add('active');
    hamburgerIcon?.classList.add('hidden');
    backArrowIcon?.classList.add('active');
  }

  // Close submenu
  function closeSubmenu() {
    isSubmenuOpen = false;
    servicePanel?.classList.remove('active');
    hamburgerIcon?.classList.remove('hidden');
    backArrowIcon?.classList.remove('active');
  }

  // Close everything
  function closeAll() {
    closeSubmenu();
    mainPanel?.classList.remove('active');
    mobileMenuToggle?.classList.remove('active');
    mobileMenuOverlay?.classList.remove('active');
  }

  // Event listeners
  openServicesMenu?.addEventListener('click', (e) => {
    e.preventDefault();
    openSubmenu();
  });

  mobileMenuToggle?.addEventListener('click', () => {
    if (isSubmenuOpen) {
      closeSubmenu();
    } else {
      toggleMainMenu();
    }
  });

  mobileMenuOverlay?.addEventListener('click', () => {
    if (isSubmenuOpen) {
      closeAll();
    } else {
      toggleMainMenu();
    }
  });
</script>
